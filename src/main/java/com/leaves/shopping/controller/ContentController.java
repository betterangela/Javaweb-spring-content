package com.leaves.shopping.controller;

import javax.annotation.Resource;

import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.leaves.shopping.dto.ContentDto;
import com.leaves.shopping.mapper.ContentMapper;
import com.leaves.shopping.model.Content;
import com.leaves.shopping.service.ContentService;
import com.leaves.shopping.util.Result;

/**
 * @author betterangela CreateTime: 2017-10-24 22:48
 */
@Controller
@RequestMapping("/content")
public class ContentController {

	@Resource
	private ContentMapper contentMapper;

	@Resource
	private ContentService contentService;

	/**
	 * 跳转内容编辑页面
	 * 
	 * @param cid 内容ID
	 * @param map map
	 * @return 页面
	 * @throws Exception exception
	 */
	@RequestMapping(value = "/edit", method = RequestMethod.GET)
	public String editPage(@RequestParam("id") Integer cid, ModelMap map) throws Exception {
		// 获取商品信息
		Content content = contentMapper.selectByPrimaryKey(cid);

		ContentDto contentDto = new ContentDto();
		contentDto.setId(content.getId());
		contentDto.setTitle(content.getTitle());
		contentDto.setSummary(content.getSummary());
		contentDto.setPrice(content.getPrice());
		contentDto.setSalePrice(content.getSalePrice());
		byte[] icon = content.getIcon();
		if (icon != null) {
			contentDto.setImage(new String(icon, "utf-8"));
		}
		byte[] text = content.getText();
		if (text != null) {
			contentDto.setDetail(new String(text, "utf-8"));
		}

		map.addAttribute("product", contentDto);

		return "edit";
	}

	/**
	 * 保存内容修改
	 * 
	 * @param id        内容ID
	 * @param title     标题
	 * @param summary   摘要
	 * @param price     价格
	 * @param salePrice 促销价
	 * @param image     图片地址
	 * @param detail    正文
	 * @param map       map
	 * @return 内容
	 * @throws Exception exception
	 */
	@RequestMapping(value = "/editSubmit", method = RequestMethod.POST)
	public String editSubmit(@RequestParam("id") Integer id, @RequestParam("title") String title,
			@RequestParam("summary") String summary, @RequestParam("price") Double price,
			@RequestParam("salePrice") Double salePrice, @RequestParam("image") String image,
			@RequestParam("detail") String detail, ModelMap map) throws Exception {
		try {
			Content content = new Content();
			content.setId(id);
			content.setTitle(title);
			content.setSummary(summary);
			content.setPrice(price);
			content.setSalePrice(salePrice);
			content.setIcon(image.getBytes("utf-8"));
			content.setText(detail.getBytes("utf-8"));
			ContentDto contentDto = contentService.editContent(content);

			map.addAttribute("product", contentDto);
			return "editSubmit";
		} catch (Exception e) {
			return null;
		}
	}

	/**
	 * 删除内容
	 * 
	 * @param cid 内容ID
	 * @return 删除结果
	 * @throws Exception exception
	 */
	@RequestMapping(value = "/delete", method = RequestMethod.POST)
	@ResponseBody
	public Object delete(@RequestParam("cid") Integer cid) throws Exception {
		try {
			contentService.deleteContent(cid);

			return Result.success();
		} catch (Exception e) {
			return Result.failed("内容删除失败");
		}
	}

	/**
	 * 切换内容状态
	 * 
	 * @param cid 内容ID
	 * @return 切换结果
	 * @throws Exception exception
	 */
	@RequestMapping(value = "/switchStatus", method = RequestMethod.POST)
	@ResponseBody
	public Object switchStatus(@RequestParam("cid") Integer cid) throws Exception {
		try {
			contentService.switchStatus(cid);

			return Result.success();
		} catch (Exception e) {
			return Result.failed();
		}
	}
}
